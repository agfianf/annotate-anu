// AnnotateANU Database Schema
// Generated from api-core SQLAlchemy models
// https://dbdiagram.io
//
// Last Updated: 2025-12-20
// Recent Changes:
// - Made tags project-specific (added project_id to tags and shared_image_tags)
// - Added Data Management feature tables (shared_images, tags, shared_image_tags, project_images)
// - Enhanced images table with shared_image_id reference
// - Added support for file share image registry with tagging system

Project annotate_anu {
  database_type: 'PostgreSQL'
  Note: 'Image annotation platform for machine learning datasets'
}

// =============================================================================
// USERS & AUTHENTICATION
// =============================================================================

Table users {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  email varchar(255) [unique, not null, note: 'User email address']
  username varchar(50) [unique, not null, note: 'Unique username']
  hashed_password varchar(255) [not null, note: 'Bcrypt hashed password']
  full_name varchar(255) [not null, note: "User's full name"]
  role varchar(20) [not null, default: 'annotator', note: 'User role: admin, member, annotator']
  is_active boolean [not null, default: true, note: 'Whether the user account is active']
  deleted_at timestamptz [note: 'Soft delete timestamp']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    email [name: 'ix_users_email']
    username [name: 'ix_users_username']
    role [name: 'ix_users_role']
    is_active [name: 'ix_users_is_active']
  }
}

Table refresh_tokens {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id, note: 'User this token belongs to']
  token_hash varchar(255) [unique, not null, note: 'SHA256 hash of the refresh token']
  expires_at timestamptz [not null, note: 'Token expiration timestamp']
  is_revoked boolean [not null, default: false, note: 'Whether token is revoked']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    user_id [name: 'ix_refresh_tokens_user_id']
    token_hash [name: 'ix_refresh_tokens_token_hash']
  }
}

// =============================================================================
// PROJECTS & PERMISSIONS
// =============================================================================

Table projects {
  id int [pk, increment, note: 'Auto-incrementing primary key']
  name varchar(255) [not null, note: 'Project display name']
  slug varchar(255) [unique, not null, note: 'URL-safe project identifier']
  description text [note: 'Project description']
  readme text [note: 'Markdown readme content']
  annotation_types "varchar(50)[]" [not null, default: '{classification}', note: 'Enabled annotation types']
  owner_id uuid [not null, ref: > users.id, note: 'Project owner']
  storage_prefix varchar(512) [note: 'S3/MinIO prefix for this project']
  is_archived boolean [not null, default: false, note: 'Whether project is archived']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    slug [name: 'ix_projects_slug']
    owner_id [name: 'ix_projects_owner_id']
  }
}

Table project_members {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  user_id uuid [not null, ref: > users.id, note: 'Member user']
  role varchar(20) [not null, default: 'annotator', note: 'Role: owner, maintainer, annotator, viewer']
  allowed_task_ids "int[]" [note: 'Scoped access to specific tasks (null = all)']
  allowed_job_ids "int[]" [note: 'Scoped access to specific jobs (null = all)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_project_members_project_id']
    user_id [name: 'ix_project_members_user_id']
    (project_id, user_id) [unique, name: 'ix_project_members_unique']
  }
}

Table labels {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Label name']
  color varchar(7) [not null, default: '#FF0000', note: 'Hex color code']
  parent_id uuid [ref: > labels.id, note: 'Parent label for hierarchy']
  hotkey varchar(1) [note: 'Keyboard shortcut (1-9, a-z)']
  applicable_types "varchar(50)[]" [not null, default: '{classification,detection,segmentation}', note: 'Annotation types this label applies to']
  attributes_schema jsonb [default: '[]', note: 'Schema for per-annotation attributes']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_labels_project_id']
    (project_id, name) [unique, name: 'ix_labels_unique']
  }
}

// =============================================================================
// TASKS & JOBS
// =============================================================================

Table tasks {
  id int [pk, increment, note: 'Auto-incrementing primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Task name']
  description text [note: 'Task description']
  assignee_id uuid [ref: > users.id, note: 'Assigned user']
  status varchar(20) [not null, default: 'pending', note: 'Status: pending, in_progress, completed, review, approved']
  is_approved boolean [not null, default: false, note: 'QA approval status']
  approved_by uuid [ref: > users.id, note: 'User who approved']
  approved_at timestamptz [note: 'Approval timestamp']
  version int [not null, default: 1, note: 'Auto-incrementing version on annotation changes']
  total_images int [not null, default: 0, note: 'Total image count (cached)']
  annotated_images int [not null, default: 0, note: 'Annotated image count (cached)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_tasks_project_id']
    assignee_id [name: 'ix_tasks_assignee_id']
    status [name: 'ix_tasks_status']
  }
}

Table jobs {
  id int [pk, increment, note: 'Auto-incrementing primary key']
  task_id int [not null, ref: > tasks.id, note: 'Parent task']
  sequence_number int [not null, note: 'Order within task']
  assignee_id uuid [ref: > users.id, note: 'Assigned annotator']
  status varchar(20) [not null, default: 'pending', note: 'Status: pending, assigned, in_progress, completed, review, approved, rejected']
  is_approved boolean [not null, default: false, note: 'QA approval status']
  approved_by uuid [ref: > users.id, note: 'User who approved']
  approved_at timestamptz [note: 'Approval timestamp']
  rejection_reason text [note: 'Reason for rejection']
  version int [not null, default: 1, note: 'Auto-incrementing version on annotation changes']
  total_images int [not null, default: 0, note: 'Total image count (cached)']
  annotated_images int [not null, default: 0, note: 'Annotated image count (cached)']
  started_at timestamptz [note: 'When work started']
  completed_at timestamptz [note: 'When work completed']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    task_id [name: 'ix_jobs_task_id']
    assignee_id [name: 'ix_jobs_assignee_id']
    status [name: 'ix_jobs_status']
    (task_id, sequence_number) [unique, name: 'ix_jobs_unique']
  }
}

// =============================================================================
// DATA MANAGEMENT - Shared Image Registry
// =============================================================================

Table shared_images {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  file_path varchar(1024) [unique, not null, note: 'Relative path from /data/share']
  filename varchar(512) [not null, note: 'Original filename']
  width int [note: 'Image width in pixels']
  height int [note: 'Image height in pixels']
  file_size_bytes bigint [note: 'File size in bytes']
  mime_type varchar(100) [note: 'MIME type']
  checksum_sha256 varchar(64) [note: 'SHA256 checksum for deduplication']
  metadata jsonb [default: '{}', note: 'Extensible metadata (EXIF, custom fields)']
  registered_by uuid [ref: > users.id, note: 'User who registered this image']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    file_path [name: 'ix_shared_images_file_path']
    registered_by [name: 'ix_shared_images_registered_by']
  }
}

Table tags {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Reference to project']
  name varchar(100) [not null, note: 'Tag name (unique per project)']
  description varchar(500) [note: 'Tag description']
  color varchar(7) [default: '#6B7280', note: 'Hex color code for UI display']
  created_by uuid [ref: > users.id, note: 'User who created this tag']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_tags_project_id']
    name [name: 'ix_tags_name']
    (project_id, name) [unique, name: 'ix_tags_unique']
  }
}

Table shared_image_tags {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Reference to project']
  shared_image_id uuid [not null, ref: > shared_images.id, note: 'Parent shared image']
  tag_id uuid [not null, ref: > tags.id, note: 'Applied tag']
  created_by uuid [ref: > users.id, note: 'User who tagged the image']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_shared_image_tags_project']
    shared_image_id [name: 'ix_shared_image_tags_image']
    tag_id [name: 'ix_shared_image_tags_tag']
    (project_id, shared_image_id, tag_id) [unique, name: 'ix_shared_image_tags_unique']
  }
}

Table project_images {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  shared_image_id uuid [not null, ref: > shared_images.id, note: 'Shared image in pool']
  added_by uuid [ref: > users.id, note: 'User who added image to pool']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_project_images_project']
    shared_image_id [name: 'ix_project_images_image']
    (project_id, shared_image_id) [unique, name: 'ix_project_images_unique']
  }
}

// =============================================================================
// IMAGES
// =============================================================================

Table images {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  job_id int [not null, ref: > jobs.id, note: 'Parent job']
  filename varchar(512) [not null, note: 'Original filename']
  s3_key varchar(1024) [not null, note: 'Full path in MinIO/S3 or file share']
  s3_bucket varchar(255) [not null, default: 'annotate-anu', note: 'S3 bucket name or "file-share"']
  width int [not null, note: 'Image width in pixels']
  height int [not null, note: 'Image height in pixels']
  thumbnail_s3_key varchar(1024) [note: 'Thumbnail path in S3']
  file_size_bytes bigint [note: 'File size in bytes']
  mime_type varchar(100) [note: 'MIME type']
  checksum_sha256 varchar(64) [note: 'SHA256 checksum']
  metadata jsonb [default: '{}', note: 'Custom metadata (EXIF, camera info, etc.)']
  sequence_number int [not null, note: 'Order within job']
  is_annotated boolean [not null, default: false, note: 'Has any annotations']
  shared_image_id uuid [ref: > shared_images.id, note: 'Link to shared image registry (nullable for backward compatibility)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    job_id [name: 'ix_images_job_id']
    s3_key [name: 'ix_images_s3_key']
    shared_image_id [name: 'ix_images_shared_image_id']
    (job_id, is_annotated) [name: 'ix_images_annotated']
    (job_id, sequence_number) [unique, name: 'ix_images_unique']
  }
}

// =============================================================================
// ANNOTATIONS - Classification
// =============================================================================

Table image_tags {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  confidence float [note: 'Confidence score (for model predictions)']
  source varchar(50) [not null, default: 'manual', note: 'Source: manual, model:<id>, import']
  created_by uuid [ref: > users.id, note: 'User who created']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_image_tags_image_id']
    label_id [name: 'ix_image_tags_label_id']
    (image_id, label_id) [unique, name: 'ix_image_tags_unique']
  }
}

// =============================================================================
// ANNOTATIONS - Object Detection (Bounding Boxes)
// =============================================================================

Table detections {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  x_min float [not null, note: 'Left edge (0-1 normalized)']
  y_min float [not null, note: 'Top edge (0-1 normalized)']
  x_max float [not null, note: 'Right edge (0-1 normalized)']
  y_max float [not null, note: 'Bottom edge (0-1 normalized)']
  rotation float [default: 0, note: 'Rotation in degrees']
  confidence float [note: 'Confidence score']
  attributes jsonb [default: '{}', note: 'Custom attributes (occluded, truncated, etc.)']
  source varchar(50) [not null, default: 'manual']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_detections_image_id']
    label_id [name: 'ix_detections_label_id']
  }
}

// =============================================================================
// ANNOTATIONS - Segmentation (Polygons/Masks)
// =============================================================================

Table segmentations {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  format varchar(20) [not null, default: 'polygon', note: 'Format: polygon, rle, bitmap']
  polygon jsonb [note: 'Array of [x, y] normalized coordinates']
  rle jsonb [note: 'Run-length encoding for masks']
  mask_s3_key varchar(1024) [note: 'External mask reference']
  bbox_x_min float [note: 'Cached bounding box left']
  bbox_y_min float [note: 'Cached bounding box top']
  bbox_x_max float [note: 'Cached bounding box right']
  bbox_y_max float [note: 'Cached bounding box bottom']
  area float [note: 'Cached area']
  confidence float [note: 'Confidence score']
  attributes jsonb [default: '{}']
  source varchar(50) [not null, default: 'manual']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_segmentations_image_id']
    label_id [name: 'ix_segmentations_label_id']
  }
}

// =============================================================================
// ANNOTATIONS - Keypoints & Pose Estimation
// =============================================================================

Table keypoints {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  skeleton_id uuid [note: 'Reference to skeleton definition']
  points jsonb [not null, note: 'Array of {name, x, y, visibility}']
  bbox_x_min float [note: 'Optional bounding box left']
  bbox_y_min float [note: 'Optional bounding box top']
  bbox_x_max float [note: 'Optional bounding box right']
  bbox_y_max float [note: 'Optional bounding box bottom']
  confidence float [note: 'Confidence score']
  attributes jsonb [default: '{}']
  source varchar(50) [not null, default: 'manual']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_keypoints_image_id']
  }
}

Table pose_skeletons {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Skeleton name (e.g., COCO Person, Hand)']
  keypoint_names jsonb [not null, note: 'Array of keypoint names']
  skeleton jsonb [not null, note: 'Array of [from, to] index pairs for connections']
  keypoint_colors jsonb [note: 'Array of colors for each keypoint']
  limb_colors jsonb [note: 'Array of colors for each limb']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_pose_skeletons_project_id']
    (project_id, name) [unique, name: 'ix_pose_skeletons_unique']
  }
}

// =============================================================================
// HISTORY & EVENT SOURCING
// =============================================================================

Table annotation_events {
  id uuid [pk, default: `gen_random_uuid()`]
  target_type varchar(20) [not null, note: 'Type: tag, detection, segmentation, keypoint']
  target_id uuid [not null, note: 'ID of the annotation']
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  event_type varchar(20) [not null, note: 'Type: create, update, delete, bulk_create, bulk_delete, import, model_prediction']
  previous_state jsonb [note: 'State before change (null for create)']
  new_state jsonb [note: 'State after change (null for delete)']
  actor_id uuid [ref: > users.id, note: 'User who performed action']
  actor_type varchar(50) [not null, default: 'user', note: 'Type: user, model, system']
  job_version int [not null, note: 'Job version at time of event']
  task_version int [not null, note: 'Task version at time of event']
  metadata jsonb [default: '{}', note: 'Additional event metadata']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_annotation_events_image_id']
    created_at [name: 'ix_annotation_events_created_at']
    (image_id, job_version) [name: 'ix_annotation_events_job_version']
  }
}

Table version_snapshots {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id int [not null, ref: > jobs.id, note: 'Parent job']
  version int [not null, note: 'Version number']
  snapshot_s3_key varchar(1024) [note: 'S3 path for large snapshots']
  annotations_snapshot jsonb [note: 'Inline snapshot for small datasets']
  image_count int [not null, note: 'Number of images in snapshot']
  annotation_count int [not null, note: 'Number of annotations in snapshot']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    job_id [name: 'ix_version_snapshots_job_id']
    (job_id, version) [unique, name: 'ix_version_snapshots_unique']
  }
}

// =============================================================================
// ACTIVITY TRACKING
// =============================================================================

Table project_activity {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  entity_type varchar(20) [not null, note: 'Type: task, job, label, member, project']
  entity_id uuid [not null, note: 'ID of the affected entity']
  entity_name varchar(255) [note: 'Name of the entity at time of action']
  action varchar(30) [not null, note: 'Action: created, updated, deleted, status_changed, assigned']
  actor_id uuid [ref: > users.id, note: 'User who performed the action']
  actor_name varchar(255) [note: 'Denormalized actor name for display']
  previous_data jsonb [note: 'State before change (null for create)']
  new_data jsonb [note: 'State after change (null for delete)']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_project_activity_project_id']
    created_at [name: 'ix_project_activity_created_at']
    (project_id, entity_type, entity_id) [name: 'ix_project_activity_entity']
  }
}

// =============================================================================
// TABLE GROUPS (Visual Organization)
// =============================================================================

TableGroup auth {
  users
  refresh_tokens
}

TableGroup projects {
  projects
  project_members
  labels
}

TableGroup data_management {
  shared_images
  tags
  shared_image_tags
  project_images
}

TableGroup workflow {
  tasks
  jobs
  images
}

TableGroup annotations {
  image_tags
  detections
  segmentations
  keypoints
  pose_skeletons
}

TableGroup history {
  annotation_events
  version_snapshots
  project_activity
}
