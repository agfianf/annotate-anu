// AnnotateANU Database Schema
// Snapshot of the API Core schema for documentation.
// Source of truth: `apps/api-core/src/app/models/`
// Update this file when models or Alembic migrations change.
// Last updated: 2026-01-04

Project annotate_anu {
  database_type: 'PostgreSQL'
  Note: 'Image annotation platform for machine learning datasets'
}

// =============================================================================
// USERS & AUTHENTICATION
// =============================================================================

Table users {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  email varchar(255) [unique, not null, note: 'User email address']
  username varchar(50) [unique, not null, note: 'Unique username']
  hashed_password varchar(255) [not null, note: 'Bcrypt hashed password']
  full_name varchar(255) [not null, note: "User's full name"]
  role varchar(20) [not null, default: 'annotator', note: 'User role: admin, member, annotator']
  is_active boolean [not null, default: true, note: 'Whether the user account is active']
  deleted_at timestamptz [note: 'Soft delete timestamp']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    email [name: 'ix_users_email']
    username [name: 'ix_users_username']
    role [name: 'ix_users_role']
    is_active [name: 'ix_users_is_active']
  }
}

Table refresh_tokens {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id, note: 'User this token belongs to']
  token_hash varchar(255) [unique, not null, note: 'SHA256 hash of the refresh token']
  expires_at timestamptz [not null, note: 'Token expiration timestamp']
  is_revoked boolean [not null, default: false, note: 'Whether token is revoked']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    user_id [name: 'ix_refresh_tokens_user_id']
    token_hash [name: 'ix_refresh_tokens_token_hash']
  }
}

// =============================================================================
// PROJECTS & PERMISSIONS
// =============================================================================

Table projects {
  id int [pk, increment, note: 'Auto-incrementing primary key']
  name varchar(255) [not null, note: 'Project display name']
  slug varchar(255) [unique, not null, note: 'URL-safe project identifier']
  description text [note: 'Project description']
  readme text [note: 'Markdown readme content']
  annotation_types "varchar(50)[]" [not null, default: '{classification}', note: 'Enabled annotation types']
  owner_id uuid [not null, ref: > users.id, note: 'Project owner']
  storage_prefix varchar(512) [note: 'S3/MinIO prefix for this project']
  is_archived boolean [not null, default: false, note: 'Whether project is archived']
  allowed_model_ids "varchar(64)[]" [note: 'Allowed BYOM model IDs (null = all models)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    slug [name: 'ix_projects_slug']
    owner_id [name: 'ix_projects_owner_id']
  }

  Note: 'allowed_model_ids column exists in model but NOT YET migrated'
}

Table project_members {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  user_id uuid [not null, ref: > users.id, note: 'Member user']
  role varchar(20) [not null, default: 'annotator', note: 'Role: owner, maintainer, annotator, viewer']
  allowed_task_ids "int[]" [note: 'Scoped access to specific tasks (null = all)']
  allowed_job_ids "int[]" [note: 'Scoped access to specific jobs (null = all)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_project_members_project_id']
    user_id [name: 'ix_project_members_user_id']
    (project_id, user_id) [unique, name: 'ix_project_members_unique']
  }
}

Table labels {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Label name']
  color varchar(7) [not null, default: '#FF0000', note: 'Hex color code']
  parent_id uuid [ref: > labels.id, note: 'Parent label for hierarchy']
  hotkey varchar(1) [note: 'Keyboard shortcut (1-9, a-z)']
  applicable_types "varchar(50)[]" [not null, default: '{classification,detection,segmentation}', note: 'Annotation types this label applies to']
  attributes_schema jsonb [default: '[]', note: 'Schema for per-annotation attributes']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_labels_project_id']
    (project_id, name) [unique, name: 'ix_labels_unique']
  }
}

// =============================================================================
// TASKS & JOBS
// =============================================================================

Table tasks {
  id int [pk, increment, note: 'Auto-incrementing primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Task name']
  description text [note: 'Task description']
  assignee_id uuid [ref: > users.id, note: 'Assigned user']
  status varchar(20) [not null, default: 'pending', note: 'Status: pending, in_progress, completed, review, approved']
  is_archived boolean [not null, default: false, note: 'Whether task is archived']
  is_approved boolean [not null, default: false, note: 'QA approval status']
  approved_by uuid [ref: > users.id, note: 'User who approved']
  approved_at timestamptz [note: 'Approval timestamp']
  version int [not null, default: 1, note: 'Auto-incrementing version on annotation changes']
  split varchar(10) [note: 'Dataset split: train, val, test, or null (none)']
  total_images int [not null, default: 0, note: 'Total image count (cached)']
  annotated_images int [not null, default: 0, note: 'Annotated image count (cached)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_tasks_project_id']
    assignee_id [name: 'ix_tasks_assignee_id']
    status [name: 'ix_tasks_status']
  }
}

Table jobs {
  id int [pk, increment, note: 'Auto-incrementing primary key']
  task_id int [not null, ref: > tasks.id, note: 'Parent task']
  sequence_number int [not null, note: 'Order within task']
  assignee_id uuid [ref: > users.id, note: 'Assigned annotator']
  status varchar(20) [not null, default: 'pending', note: 'Status: pending, assigned, in_progress, completed, review, approved, rejected']
  is_archived boolean [not null, default: false, note: 'Whether job is archived']
  is_approved boolean [not null, default: false, note: 'QA approval status']
  approved_by uuid [ref: > users.id, note: 'User who approved']
  approved_at timestamptz [note: 'Approval timestamp']
  rejection_reason text [note: 'Reason for rejection']
  version int [not null, default: 1, note: 'Auto-incrementing version on annotation changes']
  total_images int [not null, default: 0, note: 'Total image count (cached)']
  annotated_images int [not null, default: 0, note: 'Annotated image count (cached)']
  started_at timestamptz [note: 'When work started']
  completed_at timestamptz [note: 'When work completed']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    task_id [name: 'ix_jobs_task_id']
    assignee_id [name: 'ix_jobs_assignee_id']
    status [name: 'ix_jobs_status']
    (task_id, sequence_number) [unique, name: 'ix_jobs_unique']
  }
}

// =============================================================================
// DATA MANAGEMENT - Shared Image Registry
// =============================================================================

Table shared_images {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  file_path varchar(1024) [unique, not null, note: 'Relative path from SHARE_ROOT']
  filename varchar(512) [not null, note: 'Original filename']
  width int [note: 'Image width in pixels']
  height int [note: 'Image height in pixels']
  aspect_ratio float [note: 'Aspect ratio (width / height) for efficient filtering']
  file_size_bytes bigint [note: 'File size in bytes']
  mime_type varchar(100) [note: 'MIME type']
  checksum_sha256 varchar(64) [note: 'SHA256 checksum for deduplication']
  metadata jsonb [default: '{}', note: 'Extensible metadata (EXIF, custom fields)']
  registered_by uuid [ref: > users.id, note: 'User who registered this image']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    file_path [name: 'ix_shared_images_file_path']
    checksum_sha256 [name: 'ix_shared_images_checksum']
    filename [name: 'ix_shared_images_filename']
    aspect_ratio [name: 'ix_shared_images_aspect_ratio']
  }
}

Table tag_categories {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Reference to project']
  name varchar(100) [not null, note: 'Category name (unique per project, lowercase)']
  display_name varchar(255) [note: 'Human-readable display name']
  color varchar(7) [default: '#6B7280', note: 'Hex color code for UI display']
  sidebar_order int [default: 0, note: 'Order in sidebar (-1 for uncategorized)']
  is_uncategorized boolean [not null, default: false, note: 'True for the special uncategorized category (exempt from 1-per-label rule)']
  created_by uuid [ref: > users.id, note: 'User who created this category']
  created_at timestamptz [not null, default: `now()`]

  Note: '''
  Tag categories (Labels) organize tags into logical groups.
  The 1-tag-per-label rule enforces that only one tag from each
  non-uncategorized category can be applied to an image at a time.
  '''

  indexes {
    project_id [name: 'ix_tag_categories_project_id']
    (project_id, name) [unique, name: 'ix_tag_categories_project_name']
  }
}

Table tags {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Reference to project']
  category_id uuid [not null, ref: > tag_categories.id, note: 'Parent category (Label)']
  name varchar(100) [not null, note: 'Tag name (unique per project+category)']
  description varchar(500) [note: 'Tag description']
  color varchar(7) [default: '#6B7280', note: 'Hex color code for UI display']
  created_by uuid [ref: > users.id, note: 'User who created this tag']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_tags_project_id']
    category_id [name: 'ix_tags_category_id']
    name [name: 'ix_tags_name']
    (project_id, category_id, name) [unique, name: 'ix_tags_unique_per_category']
  }
}

Table shared_image_tags {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Reference to project']
  shared_image_id uuid [not null, ref: > shared_images.id, note: 'Parent shared image']
  tag_id uuid [not null, ref: > tags.id, note: 'Applied tag']
  category_id uuid [not null, ref: > tag_categories.id, note: 'Denormalized category for 1-per-label constraint enforcement']
  created_by uuid [ref: > users.id, note: 'User who tagged the image']
  created_at timestamptz [not null, default: `now()`]

  Note: '''
  Junction table linking images to tags within a project.
  The category_id is denormalized from tags for efficient 1-per-label
  constraint checking. The composite index on (project_id, shared_image_id, category_id)
  enables O(1) conflict detection when adding tags.
  '''

  indexes {
    project_id [name: 'ix_shared_image_tags_project']
    shared_image_id [name: 'ix_shared_image_tags_image']
    tag_id [name: 'ix_shared_image_tags_tag']
    (project_id, shared_image_id, tag_id) [unique, name: 'ix_shared_image_tags_unique']
    (project_id, shared_image_id, category_id) [name: 'ix_shared_image_tags_category_lookup', note: 'Efficient lookup for 1-per-label constraint']
  }
}

Table project_images {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  shared_image_id uuid [not null, ref: > shared_images.id, note: 'Shared image in pool']
  added_by uuid [ref: > users.id, note: 'User who added image to pool']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_project_images_project']
    shared_image_id [name: 'ix_project_images_image']
    (project_id, shared_image_id) [unique, name: 'ix_project_images_unique']
  }
}

// =============================================================================
// ATTRIBUTE SCHEMAS - Define structured attributes per project (FiftyOne-style)
// =============================================================================

Table attribute_schemas {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(100) [not null, note: 'Attribute name (unique per project)']
  display_name varchar(255) [note: 'Human-readable display name']
  field_type varchar(50) [not null, note: 'Type: categorical, numeric, boolean, string']
  allowed_values jsonb [note: 'For categorical: allowed value list']
  default_value varchar(255) [note: 'Default value for new images']
  min_value float [note: 'For numeric: minimum value']
  max_value float [note: 'For numeric: maximum value']
  unit varchar(50) [note: 'For numeric: unit (e.g., score, percentage)']
  color varchar(7) [default: '#6B7280', note: 'Hex color for UI']
  icon varchar(50) [note: 'Icon name for UI']
  sidebar_order int [default: 0, note: 'Order in sidebar']
  is_filterable boolean [default: true, note: 'Show in sidebar filter']
  is_visible boolean [default: true, note: 'Visible in UI']
  created_by uuid [ref: > users.id, note: 'User who created this schema']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_attribute_schemas_project']
    (project_id, name) [unique, name: 'ix_attribute_schemas_unique']
  }
}

Table image_attributes {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  shared_image_id uuid [not null, ref: > shared_images.id, note: 'Parent image']
  attribute_schema_id uuid [not null, ref: > attribute_schemas.id, note: 'Attribute schema']
  value_categorical varchar(255) [note: 'Value for categorical fields']
  value_numeric float [note: 'Value for numeric fields']
  value_boolean boolean [note: 'Value for boolean fields']
  value_string text [note: 'Value for string fields']
  value_json jsonb [note: 'Value for JSON fields']
  confidence float [note: 'Confidence score for predictions']
  source varchar(50) [default: 'manual', note: 'Source: manual, model:<id>, import']
  created_by uuid [ref: > users.id, note: 'User who set this value']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_image_attributes_project']
    shared_image_id [name: 'ix_image_attributes_image']
    attribute_schema_id [name: 'ix_image_attributes_schema']
    (project_id, shared_image_id, attribute_schema_id) [unique, name: 'ix_image_attributes_unique']
    value_categorical [name: 'ix_image_attributes_categorical']
    value_numeric [name: 'ix_image_attributes_numeric']
  }
}

// =============================================================================
// IMAGE QUALITY METRICS - Computed quality metrics for shared images
// =============================================================================

Table image_quality_metrics {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  shared_image_id uuid [unique, not null, ref: > shared_images.id, note: 'Reference to shared image (one-to-one)']
  sharpness float [note: 'Sharpness score (Laplacian variance, 0-1). Higher = sharper']
  brightness float [note: 'Brightness score (mean pixel intensity, 0-1). 0.3-0.7 = optimal']
  contrast float [note: 'Contrast score (std dev of pixels, 0-1). Higher = more contrast']
  uniqueness float [note: 'Uniqueness score (1 - max similarity, 0-1). 1 = unique, 0 = duplicate']
  red_avg float [note: 'Average red channel intensity (0-1)']
  green_avg float [note: 'Average green channel intensity (0-1)']
  blue_avg float [note: 'Average blue channel intensity (0-1)']
  overall_quality float [note: 'Composite quality score (0-1). Weighted average of individual metrics']
  perceptual_hash varchar(64) [note: 'Perceptual hash (pHash) for duplicate detection']
  issues jsonb [default: '[]', note: 'List of detected issues: blur, low_brightness, high_brightness, low_contrast, duplicate']
  status quality_status [not null, default: 'pending', note: 'Computation status: pending, processing, completed, failed']
  error_message varchar(500) [note: 'Error message if computation failed']
  computed_at timestamptz [note: 'Timestamp when metrics were computed']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    shared_image_id [unique, name: 'ix_image_quality_metrics_shared_image_id']
    status [name: 'ix_image_quality_metrics_status']
    overall_quality [name: 'ix_image_quality_metrics_overall_quality']
    sharpness [name: 'ix_image_quality_metrics_sharpness']
    uniqueness [name: 'ix_image_quality_metrics_uniqueness']
    perceptual_hash [name: 'ix_image_quality_metrics_perceptual_hash']
  }
}

Table quality_jobs {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Reference to project']
  status quality_job_status [not null, default: 'pending', note: 'Job status: pending, processing, completed, failed, cancelled']
  total_images int [not null, default: 0, note: 'Total images to process (accurate count at job start)']
  processed_count int [not null, default: 0, note: 'Number of images successfully processed']
  failed_count int [not null, default: 0, note: 'Number of images that failed processing']
  celery_task_id varchar(50) [note: 'Celery task ID for cancellation']
  started_at timestamptz [note: 'Timestamp when processing started']
  completed_at timestamptz [note: 'Timestamp when processing completed']
  error_message varchar(500) [note: 'Error message if job failed']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_quality_jobs_project_id']
    status [name: 'ix_quality_jobs_status']
    created_at [name: 'ix_quality_jobs_created_at']
  }
}

// =============================================================================
// IMAGES
// =============================================================================

Table images {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  job_id int [not null, ref: > jobs.id, note: 'Parent job']
  filename varchar(512) [not null, note: 'Original filename']
  s3_key varchar(1024) [not null, note: 'Full path in MinIO/S3 or file share']
  s3_bucket varchar(255) [not null, default: 'annotate-anu', note: 'S3 bucket name or "file-share"']
  width int [not null, note: 'Image width in pixels']
  height int [not null, note: 'Image height in pixels']
  thumbnail_s3_key varchar(1024) [note: 'Thumbnail path in S3']
  file_size_bytes bigint [note: 'File size in bytes']
  mime_type varchar(100) [note: 'MIME type']
  checksum_sha256 varchar(64) [note: 'SHA256 checksum']
  metadata jsonb [default: '{}', note: 'Custom metadata (EXIF, camera info, etc.)']
  sequence_number int [not null, note: 'Order within job']
  is_annotated boolean [not null, default: false, note: 'Has any annotations']
  shared_image_id uuid [ref: > shared_images.id, note: 'Link to shared image registry (nullable for backward compatibility)']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    job_id [name: 'ix_images_job_id']
    s3_key [name: 'ix_images_s3_key']
    shared_image_id [name: 'ix_images_shared_image_id']
    (job_id, is_annotated) [name: 'ix_images_annotated']
    (job_id, sequence_number) [unique, name: 'ix_images_unique']
  }
}

// =============================================================================
// ANNOTATIONS - Classification
// =============================================================================

Table image_tags {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  confidence float [note: 'Confidence score (for model predictions)']
  source varchar(50) [not null, default: 'manual', note: 'Source: manual, model:<id>, import']
  created_by uuid [ref: > users.id, note: 'User who created']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_image_tags_image_id']
    label_id [name: 'ix_image_tags_label_id']
    (image_id, label_id) [unique, name: 'ix_image_tags_unique']
  }
}

// =============================================================================
// ANNOTATIONS - Object Detection (Bounding Boxes)
// =============================================================================

Table detections {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  x_min float [not null, note: 'Left edge (0-1 normalized)']
  y_min float [not null, note: 'Top edge (0-1 normalized)']
  x_max float [not null, note: 'Right edge (0-1 normalized)']
  y_max float [not null, note: 'Bottom edge (0-1 normalized)']
  rotation float [default: 0, note: 'Rotation in degrees']
  confidence float [note: 'Confidence score']
  attributes jsonb [default: '{}', note: 'Custom attributes (occluded, truncated, etc.)']
  source varchar(50) [not null, default: 'manual']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_detections_image_id']
    label_id [name: 'ix_detections_label_id']
  }
}

// =============================================================================
// ANNOTATIONS - Segmentation (Polygons/Masks)
// =============================================================================

Table segmentations {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  format varchar(20) [not null, default: 'polygon', note: 'Format: polygon, rle, bitmap']
  polygon jsonb [note: 'Array of [x, y] normalized coordinates']
  rle jsonb [note: 'Run-length encoding for masks']
  mask_s3_key varchar(1024) [note: 'External mask reference']
  bbox_x_min float [note: 'Cached bounding box left']
  bbox_y_min float [note: 'Cached bounding box top']
  bbox_x_max float [note: 'Cached bounding box right']
  bbox_y_max float [note: 'Cached bounding box bottom']
  area float [note: 'Cached area']
  confidence float [note: 'Confidence score']
  attributes jsonb [default: '{}']
  source varchar(50) [not null, default: 'manual']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_segmentations_image_id']
    label_id [name: 'ix_segmentations_label_id']
  }
}

// =============================================================================
// ANNOTATIONS - Keypoints & Pose Estimation
// =============================================================================

Table keypoints {
  id uuid [pk, default: `gen_random_uuid()`]
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  label_id uuid [not null, ref: > labels.id, note: 'Applied label']
  skeleton_id uuid [note: 'Reference to skeleton definition']
  points jsonb [not null, note: 'Array of {name, x, y, visibility}']
  bbox_x_min float [note: 'Optional bounding box left']
  bbox_y_min float [note: 'Optional bounding box top']
  bbox_x_max float [note: 'Optional bounding box right']
  bbox_y_max float [note: 'Optional bounding box bottom']
  confidence float [note: 'Confidence score']
  attributes jsonb [default: '{}']
  source varchar(50) [not null, default: 'manual']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_keypoints_image_id']
  }
}

Table pose_skeletons {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Skeleton name (e.g., COCO Person, Hand)']
  keypoint_names jsonb [not null, note: 'Array of keypoint names']
  skeleton jsonb [not null, note: 'Array of [from, to] index pairs for connections']
  keypoint_colors jsonb [note: 'Array of colors for each keypoint']
  limb_colors jsonb [note: 'Array of colors for each limb']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_pose_skeletons_project_id']
    (project_id, name) [unique, name: 'ix_pose_skeletons_unique']
  }
}

// =============================================================================
// EXPORT MANAGEMENT
// =============================================================================

Table saved_filters {
  id uuid [pk, default: `gen_random_uuid()`, note: 'Unique identifier']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  name varchar(255) [not null, note: 'Filter name']
  description text [note: 'Optional description']
  filter_config jsonb [not null, note: 'Complete filter specification (tag_ids, task_ids, etc.)']
  created_by uuid [ref: > users.id, note: 'User who created the filter']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_saved_filters_project_id']
    (project_id, name) [unique, name: 'ix_saved_filters_unique_name']
  }
}

Table exports {
  id uuid [pk, default: `gen_random_uuid()`, note: 'Unique identifier']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  export_mode varchar(20) [not null, note: 'Export mode: classification, detection, segmentation']
  output_format varchar(50) [not null, note: 'Output format: coco_json, manifest_csv, image_folder']
  include_images boolean [not null, default: false, note: 'Whether to include image files in export']
  filter_snapshot jsonb [not null, note: 'Complete filter state at export time']
  saved_filter_id uuid [ref: > saved_filters.id, note: 'Reference to saved filter if used']
  classification_config jsonb [note: 'Classification mapping: mode (categorized/free_form), class assignments']
  mode_options jsonb [note: 'Mode options: include_bbox_from_seg, convert_bbox_to_seg, label_filter']
  version_mode varchar(20) [not null, default: 'latest', note: 'Version mode: latest, job_version, timestamp']
  version_value varchar(50) [note: 'Version number or ISO timestamp (for job_version/timestamp modes)']
  status varchar(20) [not null, default: 'pending', note: 'Status: pending, processing, completed, failed']
  artifact_path varchar(1024) [note: 'Path to export artifact on filesystem']
  artifact_size_bytes bigint [note: 'Size of export artifact in bytes']
  name varchar(255) [note: 'Export name (auto-generated or user-provided)']
  version_number int [note: 'Auto-incrementing version number per project+mode']
  message text [note: 'User-provided message or description']
  error_message text [note: 'Error message if export failed']
  summary jsonb [note: 'Summary: image_count, annotation_count, class_counts, split_counts']
  resolved_metadata jsonb [note: 'Resolved metadata: tags/labels with names, user info, project info for versioning']
  created_by uuid [ref: > users.id, note: 'User who created the export']
  created_at timestamptz [not null, default: `now()`]
  completed_at timestamptz [note: 'When export completed (success or failure)']

  indexes {
    project_id [name: 'ix_exports_project_id']
    status [name: 'ix_exports_status']
    created_at [name: 'ix_exports_created_at']
    (project_id, export_mode, version_number) [name: 'ix_exports_project_mode_version']
  }
}

// =============================================================================
// BYOM - Bring Your Own Model
// =============================================================================

Table registered_models {
  id varchar(64) [pk, default: `gen_random_uuid()::text`, note: 'Unique model identifier (UUID as string)']
  name varchar(255) [unique, not null, note: 'Model display name']
  endpoint_url varchar(512) [not null, note: 'Model endpoint URL']
  auth_token varchar(512) [note: 'Bearer token for authentication']
  capabilities jsonb [note: 'Model capabilities (supports_text_prompt, supports_bbox_prompt, etc.)']
  endpoint_config jsonb [note: 'Custom endpoint configuration and response mapping']
  description text [note: 'Model description']
  is_active boolean [not null, default: true, note: 'Whether model is active']
  is_healthy boolean [not null, default: false, note: 'Last health check result']
  last_health_check timestamptz [note: 'Timestamp of last health check']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    name [unique, name: 'ix_registered_models_name']
    is_active [name: 'ix_registered_models_is_active']
  }

  Note: 'This table exists in model but has NO migration yet - needs to be migrated'
}

// =============================================================================
// HISTORY & EVENT SOURCING
// =============================================================================

Table annotation_events {
  id uuid [pk, default: `gen_random_uuid()`]
  target_type varchar(20) [not null, note: 'Type: tag, detection, segmentation, keypoint']
  target_id uuid [not null, note: 'ID of the annotation']
  image_id uuid [not null, ref: > images.id, note: 'Parent image']
  event_type varchar(20) [not null, note: 'Type: create, update, delete, bulk_create, bulk_delete, import, model_prediction']
  previous_state jsonb [note: 'State before change (null for create)']
  new_state jsonb [note: 'State after change (null for delete)']
  actor_id uuid [ref: > users.id, note: 'User who performed action']
  actor_type varchar(50) [not null, default: 'user', note: 'Type: user, model, system']
  job_version int [not null, note: 'Job version at time of event']
  task_version int [not null, note: 'Task version at time of event']
  metadata jsonb [default: '{}', note: 'Additional event metadata']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    image_id [name: 'ix_annotation_events_image_id']
    created_at [name: 'ix_annotation_events_created_at']
    (image_id, job_version) [name: 'ix_annotation_events_job_version']
  }
}

Table version_snapshots {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id int [not null, ref: > jobs.id, note: 'Parent job']
  version int [not null, note: 'Version number']
  snapshot_s3_key varchar(1024) [note: 'S3 path for large snapshots']
  annotations_snapshot jsonb [note: 'Inline snapshot for small datasets']
  image_count int [not null, note: 'Number of images in snapshot']
  annotation_count int [not null, note: 'Number of annotations in snapshot']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    job_id [name: 'ix_version_snapshots_job_id']
    (job_id, version) [unique, name: 'ix_version_snapshots_unique']
  }
}

// =============================================================================
// ACTIVITY TRACKING
// =============================================================================

Table project_activity {
  id uuid [pk, default: `gen_random_uuid()`, note: 'UUID primary key']
  project_id int [not null, ref: > projects.id, note: 'Parent project']
  entity_type varchar(20) [not null, note: 'Type: task, job, label, member, project']
  entity_id uuid [not null, note: 'ID of the affected entity']
  entity_name varchar(255) [note: 'Name of the entity at time of action']
  action varchar(30) [not null, note: 'Action: created, updated, deleted, status_changed, assigned']
  actor_id uuid [ref: > users.id, note: 'User who performed the action']
  actor_name varchar(255) [note: 'Denormalized actor name for display']
  previous_data jsonb [note: 'State before change (null for create)']
  new_data jsonb [note: 'State after change (null for delete)']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    project_id [name: 'ix_project_activity_project_id']
    created_at [name: 'ix_project_activity_created_at']
    (project_id, entity_type, entity_id) [name: 'ix_project_activity_entity']
  }
}

// =============================================================================
// ENUMS (PostgreSQL)
// =============================================================================

Enum quality_status {
  pending
  processing
  completed
  failed
}

Enum quality_job_status {
  pending
  processing
  completed
  failed
  cancelled
}

// =============================================================================
// TABLE GROUPS (Visual Organization)
// =============================================================================

TableGroup auth {
  users
  refresh_tokens
}

TableGroup projects {
  projects
  project_members
  labels
}

TableGroup data_management {
  shared_images
  tag_categories
  tags
  shared_image_tags
  project_images
}

TableGroup attributes {
  attribute_schemas
  image_attributes
}

TableGroup quality {
  image_quality_metrics
  quality_jobs
}

TableGroup workflow {
  tasks
  jobs
  images
}

TableGroup annotations {
  image_tags
  detections
  segmentations
  keypoints
  pose_skeletons
}

TableGroup exports {
  saved_filters
  exports
}

TableGroup byom {
  registered_models
}

TableGroup history {
  annotation_events
  version_snapshots
  project_activity
}
